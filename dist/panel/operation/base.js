"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ShaderEdge = exports.ShaderEdgeSlot = exports.VertexPositionSlot = exports.ShaderSlot = exports.ShaderSlotType = exports.resetGlobalShaderSlotID = exports.ShaderNode = exports.ShaderPropery = void 0;
const utils_1 = require("./utils");
const type_1 = require("./type");
class ShaderPropery {
    constructor(obj) {
        this.type = {};
        this.data = {};
        this.name = '';
        this.node = null;
        this.type = obj.type;
        this.data = utils_1.getJsonObject(obj.JSONnodeData);
        this.name = this.data.m_Name;
        this.name = this.name.replace(/ /g, '_');
    }
    get defaultValue() {
        return this.data.m_Value;
    }
    get concretePrecision() {
        return utils_1.getValueConcretePrecision(this.defaultValue);
    }
}
exports.ShaderPropery = ShaderPropery;
class ShaderNode {
    // subgraphNode: SubGraphNode | null = null;
    constructor(data) {
        this.type = {};
        this.data = {};
        this.priority = 0;
        this.uuid = '';
        this.slots = [];
        this.slotsMap = new Map;
        this.deps = [];
        this.depChunks = [];
        this.depVarings = [];
        this.isMasterNode = false;
        this.isPropertyNode = false;
        this.concretePrecisionType = type_1.ConcretePrecisionType.Min;
        this.fixedConcretePrecision = 0;
        this.type = data.typeInfo;
        this.data = utils_1.getJsonObject(data.JSONnodeData);
        this.uuid = this.data.m_GuidSerialized;
        this.slots = this.data.m_SerializableSlots.map(d => {
            let slot = ShaderSlot.create(d, this);
            this.slotsMap.set(slot.id, slot);
            return slot;
        });
    }
    beforeGenreateCode() {
    }
    addDependency(dep) {
        if (dep === this) {
            return;
        }
        if (!this.deps.includes(dep)) {
            this.deps.push(dep);
        }
    }
    calcConcretePrecision() {
        if (this.fixedConcretePrecision > 0) {
            this.slots.forEach(slot => {
                slot._concretePrecision = this.fixedConcretePrecision;
            });
        }
        if (this.concretePrecisionType !== type_1.ConcretePrecisionType.Fixed) {
            let finalPrecision = 1;
            if (this.concretePrecisionType === type_1.ConcretePrecisionType.Min) {
                finalPrecision = 999;
                this.inputSlots.forEach(slot => {
                    let concretePrecision = slot.concretePrecision;
                    if (slot.connectSlot) {
                        concretePrecision = slot.connectSlot.concretePrecision;
                    }
                    finalPrecision = Math.min(finalPrecision, concretePrecision);
                });
            }
            else if (this.concretePrecisionType === type_1.ConcretePrecisionType.Max) {
                finalPrecision = -999;
                this.inputSlots.forEach(slot => {
                    let concretePrecision = slot.concretePrecision;
                    if (slot.connectSlot) {
                        concretePrecision = slot.connectSlot.concretePrecision;
                    }
                    finalPrecision = Math.max(finalPrecision, concretePrecision);
                });
            }
            else if (this.concretePrecisionType === type_1.ConcretePrecisionType.Texture) {
                finalPrecision = type_1.TextureConcretePrecision.Texture2D;
            }
            else {
                console.error('Not supported ConcretePrecisionType : ' + this.concretePrecisionType);
            }
            this.slots.forEach(slot => {
                slot._concretePrecision = finalPrecision;
            });
        }
    }
    setPriority(priority) {
        this.priority = Math.max(priority, this.priority);
        for (let i = 0; i < this.deps.length; i++) {
            this.deps[i].setPriority(this.priority + 1);
        }
    }
    get outputSlots() {
        return this.slots.filter(s => s.type === ShaderSlotType.Output);
    }
    get inputSlots() {
        return this.slots.filter(s => s.type === ShaderSlotType.Input);
    }
    getSlotWithSlotName(name) {
        return this.slots.find(s => s.displayName === name);
    }
    getOutputSlotWithSlotName(name) {
        return this.outputSlots.find(s => s.displayName === name);
    }
    getOutputVarName(idx) {
        return this.outputSlots[idx].varName;
    }
    getOutputVarDefine(idx) {
        return this.outputSlots[idx].varDefine;
    }
    getInputValue(idx) {
        return this.inputSlots[idx].slotValue;
    }
    generateCode() {
        return '';
    }
}
exports.ShaderNode = ShaderNode;
let _GlobalShaderSlotID_ = 0;
function resetGlobalShaderSlotID() {
    _GlobalShaderSlotID_ = 0;
}
exports.resetGlobalShaderSlotID = resetGlobalShaderSlotID;
var ShaderSlotType;
(function (ShaderSlotType) {
    ShaderSlotType[ShaderSlotType["Input"] = 0] = "Input";
    ShaderSlotType[ShaderSlotType["Output"] = 1] = "Output";
})(ShaderSlotType = exports.ShaderSlotType || (exports.ShaderSlotType = {}));
class ShaderSlot {
    constructor(typeInfo, data, node) {
        this.typeInfo = {};
        this.data = {};
        this.id = 0;
        this.globalID = 0;
        this.displayName = '';
        this.connectSlots = [];
        this.node = undefined;
        this.type = ShaderSlotType.Input;
        this._concretePrecision = -1;
        this.typeInfo = typeInfo;
        this.data = data;
        this.type = this.data.m_SlotType;
        this.node = node;
        this.id = this.data.m_Id;
        this.globalID = _GlobalShaderSlotID_++;
        this.displayName = this.data.m_DisplayName;
    }
    static create(obj, node) {
        let typeInfo = obj.typeInfo;
        let data = utils_1.getJsonObject(obj.JSONnodeData);
        if (data.m_DisplayName === 'Vertex Position') {
            return new VertexPositionSlot(typeInfo, data, node);
        }
        return new ShaderSlot(typeInfo, data, node);
    }
    get connectSlot() {
        return this.connectSlots[0];
    }
    ;
    set connectSlot(v) {
        this.connectSlots.length = 0;
        if (v) {
            this.connectSlots[0] = v;
        }
    }
    get varName() {
        var _a;
        if ((_a = this.node) === null || _a === void 0 ? void 0 : _a.isPropertyNode) {
            return this.node.property.name;
        }
        return 'var_' + this.globalID;
    }
    get varDefine() {
        let name = utils_1.getPrecisionName(this.concretePrecision);
        if (name) {
            name += ' ';
        }
        return name + this.varName;
    }
    get defaultValue() {
        let defaultValue = this.data.m_Value;
        let x = utils_1.getFloatString(defaultValue.x);
        let y = utils_1.getFloatString(defaultValue.y);
        let z = utils_1.getFloatString(defaultValue.z);
        let w = utils_1.getFloatString(defaultValue.w);
        let result = utils_1.getFloatString(defaultValue);
        if (typeof defaultValue === 'object') {
            if (defaultValue.w !== undefined) {
                result = `vec4(${x}, ${y}, ${z}, ${w})`;
            }
            else if (defaultValue.z !== undefined) {
                result = `vec3(${x}, ${y}, ${z})`;
            }
            else if (defaultValue.y !== undefined) {
                result = `vec2(${x}, ${y})`;
            }
        }
        return result;
    }
    get slotValue() {
        let valueConretePresition = this.defaultConcretePrecision;
        let selfConcretePresition = this.concretePrecision;
        let defaultValue = this.data.m_Value;
        let x = utils_1.getValueElementStr(defaultValue, 0);
        let y = utils_1.getValueElementStr(defaultValue, 1);
        let z = utils_1.getValueElementStr(defaultValue, 2);
        let w = utils_1.getValueElementStr(defaultValue, 3);
        if (typeof defaultValue !== 'object') {
            x = utils_1.getFloatString(defaultValue);
        }
        let result = '{{value}}';
        if (selfConcretePresition === 2) {
            result = `vec2({{value}})`;
        }
        else if (selfConcretePresition === 3) {
            result = `vec3({{value}})`;
        }
        else if (selfConcretePresition === 4) {
            result = `vec4({{value}})`;
        }
        let value = '';
        if (!this.connectSlot) {
            valueConretePresition = utils_1.getValueConcretePrecision(defaultValue);
            let values = [x, y, z, w];
            let concreteValues = [];
            for (let i = 0; i < selfConcretePresition; i++) {
                concreteValues.push(values[i] === undefined ? 0 : values[i]);
            }
            value = concreteValues.join(', ');
        }
        else {
            valueConretePresition = this.connectSlot.concretePrecision;
            value = this.connectSlot.varName;
            if (selfConcretePresition !== valueConretePresition) {
                if (selfConcretePresition < valueConretePresition) {
                    if (selfConcretePresition === 1) {
                        value += '.x';
                    }
                    else if (selfConcretePresition === 2) {
                        value += '.xy';
                    }
                    else if (selfConcretePresition === 3) {
                        value += '.xyz';
                    }
                }
                else {
                    if (valueConretePresition !== 1) {
                        let dif = selfConcretePresition - valueConretePresition;
                        let difValues = [];
                        for (let i = 0; i < dif; i++) {
                            difValues.push('0.');
                        }
                        value += ', ' + difValues.join(', ');
                    }
                    // if (dif === 1) {
                    //     value += `, ${x}`;
                    // }
                    // else if (dif === 2) {
                    //     value += `, ${x}, ${y}`;
                    // }
                    // else if (dif === 3) {
                    //     value += `, ${x}, ${y}, ${z}`;
                    // }
                }
            }
        }
        result = result.replace('{{value}}', value);
        return result;
    }
    get defaultConcretePrecision() {
        let concretePrecision = 1;
        let value = this.data.m_Value;
        if (typeof value === 'object') {
            if (value.w !== undefined) {
                concretePrecision = 4;
            }
            else if (value.z !== undefined) {
                concretePrecision = 3;
            }
            else if (value.y !== undefined) {
                concretePrecision = 2;
            }
        }
        return concretePrecision;
    }
    get concretePrecision() {
        var _a;
        if (this._concretePrecision === -1) {
            let value = this.data.m_Value;
            if (value === undefined) {
                if ((_a = this.node) === null || _a === void 0 ? void 0 : _a.isPropertyNode) {
                    value = this.node.property.data.m_Value;
                }
            }
            if (value === undefined) {
                console.error('Slot Value is undefined, concrete precision maybe wrong.');
            }
            this._concretePrecision = utils_1.getValueConcretePrecision(value);
        }
        return this._concretePrecision;
    }
}
exports.ShaderSlot = ShaderSlot;
class VertexPositionSlot extends ShaderSlot {
    get concretePrecision() {
        return 3;
    }
    get slotValue() {
        let value = super.slotValue;
        return `vec4(${value}, 1.)`;
    }
}
exports.VertexPositionSlot = VertexPositionSlot;
class ShaderEdgeSlot {
    constructor() {
        this.id = 0;
        this.nodeUuid = '';
    }
    set(data) {
        this.id = data.m_SlotId;
        this.nodeUuid = data.m_NodeGUIDSerialized;
    }
}
exports.ShaderEdgeSlot = ShaderEdgeSlot;
class ShaderEdge {
    constructor(data) {
        this.type = {};
        this.data = {};
        this.input = new ShaderEdgeSlot;
        this.output = new ShaderEdgeSlot;
        this.type = data.typeInfo;
        this.data = utils_1.getJsonObject(data.JSONnodeData);
        this.input.set(this.data.m_InputSlot);
        this.output.set(this.data.m_OutputSlot);
    }
}
exports.ShaderEdge = ShaderEdge;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS9wYW5lbC9vcGVyYXRpb24vYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBMEk7QUFFMUksaUNBQXlFO0FBR3pFLE1BQWEsYUFBYTtJQU90QixZQUFhLEdBQVE7UUFOckIsU0FBSSxHQUFHLEVBQUUsQ0FBQztRQUNWLFNBQUksR0FBUSxFQUFFLENBQUE7UUFFZCxTQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ1YsU0FBSSxHQUFzQixJQUFJLENBQUM7UUFHM0IsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcscUJBQWEsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFNUMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUM3QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsSUFBSSxZQUFZO1FBQ1osT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFBSSxpQkFBaUI7UUFDakIsT0FBTyxpQ0FBeUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDeEQsQ0FBQztDQUNKO0FBdEJELHNDQXNCQztBQUlELE1BQWEsVUFBVTtJQW1CbkIsNENBQTRDO0lBRTVDLFlBQWEsSUFBUztRQXBCdEIsU0FBSSxHQUFHLEVBQUUsQ0FBQztRQUNWLFNBQUksR0FBUSxFQUFFLENBQUE7UUFFZCxhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsU0FBSSxHQUFHLEVBQUUsQ0FBQztRQUNWLFVBQUssR0FBaUIsRUFBRSxDQUFDO1FBQ3pCLGFBQVEsR0FBNEIsSUFBSSxHQUFH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QUFHLENBQUUsSUFBUztRQUNWLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztJQUM5QyxDQUFDO0NBQ0o7QUFSRCx3Q0FRQztBQUVELE1BQWEsVUFBVTtJQU9uQixZQUFhLElBQVM7UUFOdEIsU0FBSSxHQUFHLEVBQUUsQ0FBQztRQUNWLFNBQUksR0FBUSxFQUFFLENBQUE7UUFFZCxVQUFLLEdBQW1CLElBQUksY0FBYyxDQUFDO1FBQzNDLFdBQU0sR0FBbUIsSUFBSSxjQUFjLENBQUM7UUFHeEMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzFCLElBQUksQ0FBQyxJQUFJLEdBQUcscUJBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDSjtBQWRELGdDQWNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0SnNvbk9iamVjdCwgZ2V0RmxvYXRTdHJpbmcsIGdldFZhbHVlRWxlbWVudCwgZ2V0VmFsdWVFbGVtZW50U3RyLCBnZXRWYWx1ZUNvbmNyZXRlUHJlY2lzaW9uLCBnZXRQcmVjaXNpb25OYW1lIH0gZnJvbSBcIi4vdXRpbHNcIjtcclxuaW1wb3J0IHsgcmVsYXRpdmUgfSBmcm9tIFwicGF0aFwiO1xyXG5pbXBvcnQgeyBDb25jcmV0ZVByZWNpc2lvblR5cGUsIFRleHR1cmVDb25jcmV0ZVByZWNpc2lvbiB9IGZyb20gXCIuL3R5cGVcIjtcclxuaW1wb3J0IFByb3BlcnR5Tm9kZSBmcm9tICcuL25vZGVzL2lucHV0L1Byb3BlcnR5Tm9kZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgU2hhZGVyUHJvcGVyeSB7XHJcbiAgICB0eXBlID0ge307XHJcbiAgICBkYXRhOiBhbnkgPSB7fVxyXG5cclxuICAgIG5hbWUgPSAnJztcclxuICAgIG5vZGU6IFNoYWRlck5vZGUgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvciAob2JqOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnR5cGUgPSBvYmoudHlwZTtcclxuICAgICAgICB0aGlzLmRhdGEgPSBnZXRKc29uT2JqZWN0KG9iai5KU09Obm9kZURhdGEpO1xyXG5cclxuICAgICAgICB0aGlzLm5hbWUgPSB0aGlzLmRhdGEubV9OYW1lO1xyXG4gICAgICAgIHRoaXMubmFtZSA9IHRoaXMubmFtZS5yZXBsYWNlKC8gL2csICdfJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGRlZmF1bHRWYWx1ZSAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS5tX1ZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBjb25jcmV0ZVByZWNpc2lvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIGdldFZhbHVlQ29uY3JldGVQcmVjaXNpb24odGhpcy5kZWZhdWx0VmFsdWUpO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBTaGFkZXJOb2RlIHtcclxuICAgIHR5cGUgPSB7fTtcclxuICAgIGRhdGE6IGFueSA9IHt9XHJcblxyXG4gICAgcHJpb3JpdHkgPSAwO1xyXG4gICAgdXVpZCA9ICcnO1xyXG4gICAgc2xvdHM6IFNoYWRlclNsb3RbXSA9IFtdO1xyXG4gICAgc2xvdHNNYXA6IE1hcDxudW1iZXIsIFNoYWRlclNsb3Q+ID0gbmV3IE1hcDtcclxuXHJcbiAgICBkZXBzOiBTaGFkZXJOb2RlW10gPSBbXVxyXG5cclxuICAgIGRlcENodW5rczogc3RyaW5nW10gPSBbXVxyXG4gICAgZGVwVmFyaW5nczogbnVtYmVyW10gPSBbXVxyXG5cclxuICAgIGlzTWFzdGVyTm9kZSA9IGZhbHNlO1xyXG4gICAgaXNQcm9wZXJ0eU5vZGUgPSBmYWxzZTtcclxuICAgIGNvbmNyZXRlUHJlY2lzaW9uVHlwZSA9IENvbmNyZXRlUHJlY2lzaW9uVHlwZS5NaW47XHJcbiAgICBmaXhlZENvbmNyZXRlUHJlY2lzaW9uID0gMDtcclxuXHJcbiAgICAvLyBzdWJncmFwaE5vZGU6IFN1YkdyYXBoTm9kZSB8IG51bGwgPSBudWxsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yIChkYXRhOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnR5cGUgPSBkYXRhLnR5cGVJbmZvO1xyXG4gICAgICAgIHRoaXMuZGF0YSA9IGdldEpzb25PYmplY3QoZGF0YS5KU09Obm9kZURhdGEpO1xyXG5cclxuICAgICAgICB0aGlzLnV1aWQgPSB0aGlzLmRhdGEubV9HdWlkU2VyaWFsaXplZDtcclxuICAgICAgICB0aGlzLnNsb3RzID0gdGhpcy5kYXRhLm1fU2VyaWFsaXphYmxlU2xvdHMubWFwKGQgPT4ge1xyXG4gICAgICAgICAgICBsZXQgc2xvdCA9IFNoYWRlclNsb3QuY3JlYXRlKGQsIHRoaXMpO1xyXG4gICAgICAgICAgICB0aGlzLnNsb3RzTWFwLnNldChzbG90LmlkLCBzbG90KTtcclxuICAgICAgICAgICAgcmV0dXJuIHNsb3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGJlZm9yZUdlbnJlYXRlQ29kZSAoKSB7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkRGVwZW5kZW5jeSAoZGVwKSB7XHJcbiAgICAgICAgaWYgKGRlcCA9PT0gdGhpcykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5kZXBzLmluY2x1ZGVzKGRlcCkpIHtcclxuICAgICAgICAgICAgdGhpcy5kZXBzLnB1c2goZGVwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2FsY0NvbmNyZXRlUHJlY2lzaW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy5maXhlZENvbmNyZXRlUHJlY2lzaW9uID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnNsb3RzLmZvckVhY2goc2xvdCA9PiB7XHJcbiAgICAgICAgICAgICAgICBzbG90Ll9jb25jcmV0ZVByZWNpc2lvbiA9IHRoaXMuZml4ZWRDb25jcmV0ZVByZWNpc2lvbjtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuY29uY3JldGVQcmVjaXNpb25UeXBlICE9PSBDb25jcmV0ZVByZWNpc2lvblR5cGUuRml4ZWQpIHtcclxuICAgICAgICAgICAgbGV0IGZpbmFsUHJlY2lzaW9uOiBudW1iZXIgPSAxO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jb25jcmV0ZVByZWNpc2lvblR5cGUgPT09IENvbmNyZXRlUHJlY2lzaW9uVHlwZS5NaW4pIHtcclxuICAgICAgICAgICAgICAgIGZpbmFsUHJlY2lzaW9uID0gOTk5O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnB1dFNsb3RzLmZvckVhY2goc2xvdCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGNvbmNyZXRlUHJlY2lzaW9uID0gc2xvdC5jb25jcmV0ZVByZWNpc2lvbjtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc2xvdC5jb25uZWN0U2xvdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25jcmV0ZVByZWNpc2lvbiA9IHNsb3QuY29ubmVjdFNsb3QuY29uY3JldGVQcmVjaXNpb247XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGZpbmFsUHJlY2lzaW9uID0gTWF0aC5taW4oZmluYWxQcmVjaXNpb24sIGNvbmNyZXRlUHJlY2lzaW9uKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jb25jcmV0ZVByZWNpc2lvblR5cGUgPT09IENvbmNyZXRlUHJlY2lzaW9uVHlwZS5NYXgpIHtcclxuICAgICAgICAgICAgICAgIGZpbmFsUHJlY2lzaW9uID0gLTk5OTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRTbG90cy5mb3JFYWNoKHNsb3QgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjb25jcmV0ZVByZWNpc2lvbiA9IHNsb3QuY29uY3JldGVQcmVjaXNpb247XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNsb3QuY29ubmVjdFNsb3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uY3JldGVQcmVjaXNpb24gPSBzbG90LmNvbm5lY3RTbG90LmNvbmNyZXRlUHJlY2lzaW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBmaW5hbFByZWNpc2lvbiA9IE1hdGgubWF4KGZpbmFsUHJlY2lzaW9uLCBjb25jcmV0ZVByZWNpc2lvbik7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuY29uY3JldGVQcmVjaXNpb25UeXBlID09PSBDb25jcmV0ZVByZWNpc2lvblR5cGUuVGV4dHVyZSkge1xyXG4gICAgICAgICAgICAgICAgZmluYWxQcmVjaXNpb24gPSBUZXh0dXJlQ29uY3JldGVQcmVjaXNpb24uVGV4dHVyZTJEO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignTm90IHN1cHBvcnRlZCBDb25jcmV0ZVByZWNpc2lvblR5cGUgOiAnICsgdGhpcy5jb25jcmV0ZVByZWNpc2lvblR5cGUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNsb3RzLmZvckVhY2goc2xvdCA9PiB7XHJcbiAgICAgICAgICAgICAgICBzbG90Ll9jb25jcmV0ZVByZWNpc2lvbiA9IGZpbmFsUHJlY2lzaW9uO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZXRQcmlvcml0eSAocHJpb3JpdHkpIHtcclxuICAgICAgICB0aGlzLnByaW9yaXR5ID0gTWF0aC5tYXgocHJpb3JpdHksIHRoaXMucHJpb3JpdHkpO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5kZXBzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVwc1tpXS5zZXRQcmlvcml0eSh0aGlzLnByaW9yaXR5ICsgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBvdXRwdXRTbG90cyAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2xvdHMuZmlsdGVyKHMgPT4gcy50eXBlID09PSBTaGFkZXJTbG90VHlwZS5PdXRwdXQpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpbnB1dFNsb3RzICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zbG90cy5maWx0ZXIocyA9PiBzLnR5cGUgPT09IFNoYWRlclNsb3RUeXBlLklucHV0KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTbG90V2l0aFNsb3ROYW1lIChuYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2xvdHMuZmluZChzID0+IHMuZGlzcGxheU5hbWUgPT09IG5hbWUpO1xyXG4gICAgfVxyXG4gICAgZ2V0T3V0cHV0U2xvdFdpdGhTbG90TmFtZSAobmFtZSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm91dHB1dFNsb3RzLmZpbmQocyA9PiBzLmRpc3BsYXlOYW1lID09PSBuYW1lKTtcclxuICAgIH1cclxuICAgIGdldE91dHB1dFZhck5hbWUgKGlkeCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm91dHB1dFNsb3RzW2lkeF0udmFyTmFtZTtcclxuICAgIH1cclxuICAgIGdldE91dHB1dFZhckRlZmluZSAoaWR4KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3V0cHV0U2xvdHNbaWR4XS52YXJEZWZpbmU7XHJcbiAgICB9XHJcbiAgICBnZXRJbnB1dFZhbHVlIChpZHgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbnB1dFNsb3RzW2lkeF0uc2xvdFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdlbmVyYXRlQ29kZSAoKSB7XHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG59XHJcblxyXG5sZXQgX0dsb2JhbFNoYWRlclNsb3RJRF8gPSAwO1xyXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRHbG9iYWxTaGFkZXJTbG90SUQgKCkge1xyXG4gICAgX0dsb2JhbFNoYWRlclNsb3RJRF8gPSAwO1xyXG59XHJcblxyXG5leHBvcnQgZW51bSBTaGFkZXJTbG90VHlwZSB7XHJcbiAgICBJbnB1dCxcclxuICAgIE91dHB1dFxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU2hhZGVyU2xvdCB7XHJcblxyXG4gICAgc3RhdGljIGNyZWF0ZSAob2JqOiBhbnksIG5vZGU6IFNoYWRlck5vZGUpIHtcclxuICAgICAgICBsZXQgdHlwZUluZm8gPSBvYmoudHlwZUluZm87XHJcbiAgICAgICAgbGV0IGRhdGEgPSBnZXRKc29uT2JqZWN0KG9iai5KU09Obm9kZURhdGEpO1xyXG5cclxuICAgICAgICBpZiAoZGF0YS5tX0Rpc3BsYXlOYW1lID09PSAnVmVydGV4IFBvc2l0aW9uJykge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFZlcnRleFBvc2l0aW9uU2xvdCh0eXBlSW5mbywgZGF0YSwgbm9kZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3IFNoYWRlclNsb3QodHlwZUluZm8sIGRhdGEsIG5vZGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHR5cGVJbmZvID0ge307XHJcbiAgICBkYXRhOiBhbnkgPSB7fVxyXG5cclxuICAgIGlkID0gMDtcclxuXHJcbiAgICBnbG9iYWxJRCA9IDA7XHJcbiAgICBkaXNwbGF5TmFtZSA9ICcnO1xyXG5cclxuICAgIGdldCBjb25uZWN0U2xvdCAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY29ubmVjdFNsb3RzWzBdO1xyXG4gICAgfTtcclxuICAgIHNldCBjb25uZWN0U2xvdCAodikge1xyXG4gICAgICAgIHRoaXMuY29ubmVjdFNsb3RzLmxlbmd0aCA9IDA7XHJcbiAgICAgICAgaWYgKHYpIHtcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0U2xvdHNbMF0gPSB2O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbm5lY3RTbG90czogU2hhZGVyU2xvdFtdID0gW107XHJcblxyXG4gICAgbm9kZTogU2hhZGVyTm9kZSB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcclxuXHJcbiAgICB0eXBlID0gU2hhZGVyU2xvdFR5cGUuSW5wdXQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IgKHR5cGVJbmZvOiBhbnksIGRhdGE6IGFueSwgbm9kZTogU2hhZGVyTm9kZSkge1xyXG4gICAgICAgIHRoaXMudHlwZUluZm8gPSB0eXBlSW5mbztcclxuICAgICAgICB0aGlzLmRhdGEgPSBkYXRhO1xyXG5cclxuICAgICAgICB0aGlzLnR5cGUgPSB0aGlzLmRhdGEubV9TbG90VHlwZSBhcyBTaGFkZXJTbG90VHlwZTtcclxuXHJcbiAgICAgICAgdGhpcy5ub2RlID0gbm9kZTtcclxuXHJcbiAgICAgICAgdGhpcy5pZCA9IHRoaXMuZGF0YS5tX0lkO1xyXG4gICAgICAgIHRoaXMuZ2xvYmFsSUQgPSBfR2xvYmFsU2hhZGVyU2xvdElEXysrO1xyXG4gICAgICAgIHRoaXMuZGlzcGxheU5hbWUgPSB0aGlzLmRhdGEubV9EaXNwbGF5TmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdmFyTmFtZSAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMubm9kZT8uaXNQcm9wZXJ0eU5vZGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuICh0aGlzLm5vZGUgYXMgUHJvcGVydHlOb2RlKS5wcm9wZXJ0eSEubmFtZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICd2YXJfJyArIHRoaXMuZ2xvYmFsSUQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHZhckRlZmluZSAoKSB7XHJcbiAgICAgICAgbGV0IG5hbWUgPSBnZXRQcmVjaXNpb25OYW1lKHRoaXMuY29uY3JldGVQcmVjaXNpb24pO1xyXG4gICAgICAgIGlmIChuYW1lKSB7XHJcbiAgICAgICAgICAgIG5hbWUgKz0gJyAnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmFtZSArIHRoaXMudmFyTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgZGVmYXVsdFZhbHVlICgpIHtcclxuICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gdGhpcy5kYXRhLm1fVmFsdWU7XHJcblxyXG4gICAgICAgIGxldCB4ID0gZ2V0RmxvYXRTdHJpbmcoZGVmYXVsdFZhbHVlLngpO1xyXG4gICAgICAgIGxldCB5ID0gZ2V0RmxvYXRTdHJpbmcoZGVmYXVsdFZhbHVlLnkpO1xyXG4gICAgICAgIGxldCB6ID0gZ2V0RmxvYXRTdHJpbmcoZGVmYXVsdFZhbHVlLnopO1xyXG4gICAgICAgIGxldCB3ID0gZ2V0RmxvYXRTdHJpbmcoZGVmYXVsdFZhbHVlLncpO1xyXG5cclxuICAgICAgICBsZXQgcmVzdWx0ID0gZ2V0RmxvYXRTdHJpbmcoZGVmYXVsdFZhbHVlKTtcclxuICAgICAgICBpZiAodHlwZW9mIGRlZmF1bHRWYWx1ZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZS53ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGB2ZWM0KCR7eH0sICR7eX0sICR7en0sICR7d30pYDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChkZWZhdWx0VmFsdWUueiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBgdmVjMygke3h9LCAke3l9LCAke3p9KWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoZGVmYXVsdFZhbHVlLnkgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gYHZlYzIoJHt4fSwgJHt5fSlgO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBzbG90VmFsdWUgKCkge1xyXG4gICAgICAgIGxldCB2YWx1ZUNvbnJldGVQcmVzaXRpb24gPSB0aGlzLmRlZmF1bHRDb25jcmV0ZVByZWNpc2lvbjtcclxuICAgICAgICBsZXQgc2VsZkNvbmNyZXRlUHJlc2l0aW9uID0gdGhpcy5jb25jcmV0ZVByZWNpc2lvbjtcclxuICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gdGhpcy5kYXRhLm1fVmFsdWU7XHJcblxyXG4gICAgICAgIGxldCB4ID0gZ2V0VmFsdWVFbGVtZW50U3RyKGRlZmF1bHRWYWx1ZSwgMCk7XHJcbiAgICAgICAgbGV0IHkgPSBnZXRWYWx1ZUVsZW1lbnRTdHIoZGVmYXVsdFZhbHVlLCAxKTtcclxuICAgICAgICBsZXQgeiA9IGdldFZhbHVlRWxlbWVudFN0cihkZWZhdWx0VmFsdWUsIDIpO1xyXG4gICAgICAgIGxldCB3ID0gZ2V0VmFsdWVFbGVtZW50U3RyKGRlZmF1bHRWYWx1ZSwgMyk7XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgZGVmYXVsdFZhbHVlICE9PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICB4ID0gZ2V0RmxvYXRTdHJpbmcoZGVmYXVsdFZhbHVlKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBsZXQgcmVzdWx0ID0gJ3t7dmFsdWV9fSc7XHJcbiAgICAgICAgaWYgKHNlbGZDb25jcmV0ZVByZXNpdGlvbiA9PT0gMikge1xyXG4gICAgICAgICAgICByZXN1bHQgPSBgdmVjMih7e3ZhbHVlfX0pYFxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChzZWxmQ29uY3JldGVQcmVzaXRpb24gPT09IDMpIHtcclxuICAgICAgICAgICAgcmVzdWx0ID0gYHZlYzMoe3t2YWx1ZX19KWBcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoc2VsZkNvbmNyZXRlUHJlc2l0aW9uID09PSA0KSB7XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IGB2ZWM0KHt7dmFsdWV9fSlgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCB2YWx1ZSA9ICcnO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY29ubmVjdFNsb3QpIHtcclxuICAgICAgICAgICAgdmFsdWVDb25yZXRlUHJlc2l0aW9uID0gZ2V0VmFsdWVDb25jcmV0ZVByZWNpc2lvbihkZWZhdWx0VmFsdWUpO1xyXG5cclxuICAgICAgICAgICAgbGV0IHZhbHVlcyA9IFt4LCB5LCB6LCB3XTtcclxuICAgICAgICAgICAgbGV0IGNvbmNyZXRlVmFsdWVzOiBhbnlbXSA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGZDb25jcmV0ZVByZXNpdGlvbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25jcmV0ZVZhbHVlcy5wdXNoKHZhbHVlc1tpXSA9PT0gdW5kZWZpbmVkID8gMCA6IHZhbHVlc1tpXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFsdWUgPSBjb25jcmV0ZVZhbHVlcy5qb2luKCcsICcpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB2YWx1ZUNvbnJldGVQcmVzaXRpb24gPSB0aGlzLmNvbm5lY3RTbG90LmNvbmNyZXRlUHJlY2lzaW9uO1xyXG5cclxuICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmNvbm5lY3RTbG90LnZhck5hbWU7XHJcbiAgICAgICAgICAgIGlmIChzZWxmQ29uY3JldGVQcmVzaXRpb24gIT09IHZhbHVlQ29ucmV0ZVByZXNpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNlbGZDb25jcmV0ZVByZXNpdGlvbiA8IHZhbHVlQ29ucmV0ZVByZXNpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxmQ29uY3JldGVQcmVzaXRpb24gPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgKz0gJy54JztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc2VsZkNvbmNyZXRlUHJlc2l0aW9uID09PSAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICs9ICcueHknO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzZWxmQ29uY3JldGVQcmVzaXRpb24gPT09IDMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgKz0gJy54eXonO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZUNvbnJldGVQcmVzaXRpb24gIT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRpZiA9IHNlbGZDb25jcmV0ZVByZXNpdGlvbiAtIHZhbHVlQ29ucmV0ZVByZXNpdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRpZlZhbHVlczogYW55W10gPSBbXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpZjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZWYWx1ZXMucHVzaCgnMC4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAnLCAnICsgZGlmVmFsdWVzLmpvaW4oJywgJylcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgKGRpZiA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICB2YWx1ZSArPSBgLCAke3h9YDtcclxuICAgICAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gZWxzZSBpZiAoZGlmID09PSAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIHZhbHVlICs9IGAsICR7eH0sICR7eX1gO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyBlbHNlIGlmIChkaWYgPT09IDMpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgdmFsdWUgKz0gYCwgJHt4fSwgJHt5fSwgJHt6fWA7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZSgne3t2YWx1ZX19JywgdmFsdWUpO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBkZWZhdWx0Q29uY3JldGVQcmVjaXNpb24gKCkge1xyXG4gICAgICAgIGxldCBjb25jcmV0ZVByZWNpc2lvbiA9IDE7XHJcblxyXG4gICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZGF0YS5tX1ZhbHVlO1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZS53ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbmNyZXRlUHJlY2lzaW9uID0gNDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICh2YWx1ZS56ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbmNyZXRlUHJlY2lzaW9uID0gMztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICh2YWx1ZS55ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbmNyZXRlUHJlY2lzaW9uID0gMjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNvbmNyZXRlUHJlY2lzaW9uO1xyXG4gICAgfVxyXG5cclxuICAgIF9jb25jcmV0ZVByZWNpc2lvbiA9IC0xO1xyXG4gICAgZ2V0IGNvbmNyZXRlUHJlY2lzaW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy5fY29uY3JldGVQcmVjaXNpb24gPT09IC0xKSB7XHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZGF0YS5tX1ZhbHVlO1xyXG4gICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubm9kZT8uaXNQcm9wZXJ0eU5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICh0aGlzLm5vZGUgYXMgUHJvcGVydHlOb2RlKS5wcm9wZXJ0eSEuZGF0YS5tX1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdTbG90IFZhbHVlIGlzIHVuZGVmaW5lZCwgY29uY3JldGUgcHJlY2lzaW9uIG1heWJlIHdyb25nLicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbmNyZXRlUHJlY2lzaW9uID0gZ2V0VmFsdWVDb25jcmV0ZVByZWNpc2lvbih2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLl9jb25jcmV0ZVByZWNpc2lvbjtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFZlcnRleFBvc2l0aW9uU2xvdCBleHRlbmRzIFNoYWRlclNsb3Qge1xyXG4gICAgZ2V0IGNvbmNyZXRlUHJlY2lzaW9uICgpIHtcclxuICAgICAgICByZXR1cm4gMztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgc2xvdFZhbHVlICgpIHtcclxuICAgICAgICBsZXQgdmFsdWUgPSBzdXBlci5zbG90VmFsdWU7XHJcbiAgICAgICAgcmV0dXJuIGB2ZWM0KCR7dmFsdWV9LCAxLilgO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFNoYWRlckVkZ2VTbG90IHtcclxuICAgIGlkID0gMDtcclxuICAgIG5vZGVVdWlkID0gJyc7XHJcblxyXG4gICAgc2V0IChkYXRhOiBhbnkpIHtcclxuICAgICAgICB0aGlzLmlkID0gZGF0YS5tX1Nsb3RJZDtcclxuICAgICAgICB0aGlzLm5vZGVVdWlkID0gZGF0YS5tX05vZGVHVUlEU2VyaWFsaXplZDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFNoYWRlckVkZ2Uge1xyXG4gICAgdHlwZSA9IHt9O1xyXG4gICAgZGF0YTogYW55ID0ge31cclxuXHJcbiAgICBpbnB1dDogU2hhZGVyRWRnZVNsb3QgPSBuZXcgU2hhZGVyRWRnZVNsb3Q7XHJcbiAgICBvdXRwdXQ6IFNoYWRlckVkZ2VTbG90ID0gbmV3IFNoYWRlckVkZ2VTbG90O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yIChkYXRhOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnR5cGUgPSBkYXRhLnR5cGVJbmZvO1xyXG4gICAgICAgIHRoaXMuZGF0YSA9IGdldEpzb25PYmplY3QoZGF0YS5KU09Obm9kZURhdGEpO1xyXG5cclxuICAgICAgICB0aGlzLmlucHV0LnNldCh0aGlzLmRhdGEubV9JbnB1dFNsb3QpO1xyXG4gICAgICAgIHRoaXMub3V0cHV0LnNldCh0aGlzLmRhdGEubV9PdXRwdXRTbG90KTtcclxuICAgIH1cclxufSJdfQ==